# OAuth2
Reference : https://oauth.com/playground/
OAuth2 is a standard security that make a application can access others apps by using token without sharing the credential.

### 1. Authorization flows.
Condition: we had the authorization server.
Whe you registry your application with authorization server, they will provide for you the `client_id` and `redirect_url`, `scope` which will be explain after.
#### Step 1. Build the Authorization URL and redirect user to authorization server
Anyway, you application need build a Authorization URL to communicate with Authorization server.

Example: 
```url
https://authorization-server.com/authorize?
   response_type=code
   &client_id=wiu9zWBBRgimN5XVC1_edW_4
   &redirect_uri=https://oauth.com/playground/authorization-code.html
   &scope=photo+offline_access
   &state=v5hCyrCdsndv9KZV
```
- client_id, redirect_uri and scope is provided by authentication server side.
- state is your random string which is use in authentication server.
You should store your state in somewhere - cookie, session or some other way.

Your application call this url then login form appear for inputing your username and password
#### Step 2. After the user redirect back to client, verify the state matches.
The user was redirected to the client (which request to authorization server)
`?state=v5hCyrCdsndv9KZV&code=lkblOoNANqazf1jX9Lbc6D2zjNJFMPZKOMelKU9DNV_annF5`
You need to verify the `state` parameter that matches the generated state in step 1 so that protect against CSRF attacks
In this example the response tate = `v5hCyrCdsndv9KZV` equals stored state.
If match we go to step 3 else start over.
#### Step 3. Exchange the Authorization Code.
Now you are ready to exchange the authorization code for an access token.
Client build and call the url:
```url
POST https://authorization-server.com/token

grant_type=authorization_code
&client_id=wiu9zWBBRgimN5XVC1_edW_4
&client_secret=e7bp_h8D_VOTc6jIJafkzUO11sGUrFy1_7LZnO_w9dEUdyfc
&redirect_uri=https://oauth.com/playground/authorization-code.html
&code=lkblOoNANqazf1jX9Lbc6D2zjNJFMPZKOMelKU9DNV_annF5
```
- `clien_secret` that is provided by authentication server when you registry your application to use OAuth2.
- `code`: From step 2.
Because we already sign in from step 1 to recived the code - so we don't need the do that by username and password.

The response from above request.
```json
{
"token_type": "Bearer",
"expires_in": 86400,
"access_token": "o6c5yhC9AoUhYq9xGnU_lRovlXhPMF_tU1xa8zvPhilCJAqdbuuGlCyHGK5dIVAMbVM23UmD",
"scope": "photo offline_access",
"refresh_token": "oVHGnV3vBtTh-hou1QAGWQcN"
}
```
- `access_token`: token is used for access APIs on behalf of the user
Now you have the access token to access other application on behalf of the user
- `refresh_token`: token to call refresh token to get the new access_token when expired.

### 2. PKCE flows

#### Step 1: Create a secret code verifier and code challenge
Before do the authorization, we generate the code verifier and code challenge 
- `Code verifier` is a cryptographically random string using A-Z, a-z, 0-9 and punctuation characters like -._~ (hyphen, period, underscore, and tilde) bw 43-128 characters long.
- `Code challenge` use code verifier to create code challenge. That is  base64url(sha256(code_verifier)), otherwise, the same
verifier string is used as the challenge.

Don't forget to store `code verify` in somewhere.

#### Step 2: Build the Authorization URL
```
https://authorization-server.com/authorize?
  response_type=code
  &client_id=IZ44NoLfi3kzN0xubn77cCyr
  &redirect_uri=https://oauth.com/playground/authorization-code-with-pkce.html
  &scope=photo+offline_access
  &state=1uK58ZXs4CQaxUjx
  &code_challenge=nC0DWDvV4sYhILajNCC8diLJ_F_ZuhvV-_aobV0hjCU
  &code_challenge_method=S256
```

- state : generated by your.

#### Step 3: After the user redirect back to client, verify the state matches.
```
?state=1uK58ZXs4CQaxUjx&code=7tFd_VPUH544j7YgsgK2RdlX2QMy6Q733l1UyFvKUeolS2u5
```

#### Step 3. Exchange the Authorization Code
```
POST https://authorization-server.com/token

grant_type=authorization_code
&client_id=IZ44NoLfi3kzN0xubn77cCyr
&client_secret=1KC66EQQyHNU7OwK6m8iyaO1dqWtLN8s1oUFquBX2vmzSRJM
&redirect_uri=https://oauth.com/playground/authorization-code-with-pkce.html
&code=7tFd_VPUH544j7YgsgK2RdlX2QMy6Q733l1UyFvKUeolS2u5
&code_verifier=o8gVvXUrTsObm318iawmFvg4CUFO1OKAdGSMjtoSdSDKXvbI
```
- code_verifier : will be send to Authorization server. Authorization Server will check the verifier matches the challenge code
that was used in the authorization request.
This ensures that a malicious party that intercepted the authorization code will not be able to use it.

The response from token endpoint.
```json
{
  "token_type": "Bearer",
  "expires_in": 86400,
  "access_token": "Mf-PQIJKYQ1gnxPBOpLmSRpt6vAjXxCvtl9lBAhsBbexzYnuYQPZ3Dw6Jnelyz6VjS2s8RcE",
  "scope": "photo offline_access",
  "refresh_token": "QUBhZeEhXN7G7YMie1rlsar1"
}
```

- `access_token`: token is used for access APIs on behalf of the user
  Now you have the access token to access other application on behalf of the user
- `refresh_token`: token to call refresh token to get the new access_token when expired.

### 3. Implicit follow.

#### Step 1: Build the Authorization URL
```
https://authorization-server.com/authorize?
  response_type=token
  &client_id=IZ44NoLfi3kzN0xubn77cCyr
  &redirect_uri=https://oauth.com/playground/implicit.html
  &scope=photo
  &state=vw7pzq-QfDlOgrp5
```
- state : generated by you which will be use in the next step.

#### Step 2: Verify the state parameter
The response from Authorization server.
```
#access_token=6_RmZGn9ifRX5KduRMhIVT2oVJQ0QAdSPojm5MZz42GVLvYaFWwnAx7IgojlK4WDoqrN-9Qb
&token_type=Bearer&expires_in=86400
&scope=photos&state=vw7pzq-QfDlOgrp5
```
- Verify the state value with stored state (protect CSRF attacks)

This doesn't stop a malicious actor from injecting an access token into your client. No solution in OAuth for protecting the Implicit folow.

#### Step 3: Extract  the access token from response of step 2.

access_token 6_RmZGn9ifRX5KduRMhIVT2oVJQ0QAdSPojm5MZz42GVLvYaFWwnAx7IgojlK4WDoqrN-9Qb

token_type	Bearer

expires_in	86400

scope	photos

### 4. Device Code flow.
#### Step 1: Request a device code
You need to request device code, this is done with a simple POST request to `device code endpoint`.
```
POST https://example.okta.com/device     //this is device code endpoint.

client_id=https://www.oauth.com/playground/  //your webside
```
#### Step 2: Tell the User to Enter the Code.
After step 1 - the response from the server includes the device code, a code to display to the user and the URL the user should visit to enter the code.

```json
{
  "device_code": "NGU5OWFiNjQ5YmQwNGY3YTdmZTEyNzQ3YzQ1YSA",  //device code
  "user_code": "BDWD-HQPK",                                  //code display for user
  "verification_uri": "https://example.okta.com/device",    //user should to this link to input the user code from user_code field
  "interval": 5,
  "expires_in": 1800
}
```
If you would like to try with a real device code. Should use https://developers.google.com/identity/protocols/oauth2/limited-input-device

#### Step 3: Poll the Token Endpoint
While you wait for user to visit the URL, sign in the account and approve the request, you need to poll the token endpoint
with the device code until an access token or error is returned.

```
POST https://example.okta.com/token

grant_type=urn:ietf:params:oauth:grant-type:device_code
&client_id=https://www.oauth.com/playground/
&device_code=NGU5OWFiNjQ5YmQwNGY3YTdmZTEyNzQ3YzQ1YSA
```

Before the user has finished signing in and approving the request, the authorization will return a status indicating the authorization is still pending.
HTTP/1.1 400 Bad Request
```json
{
 "error": "authorization_pending"
}
```
In the case this error happen - you can re-poll the request. when the user approves the request, the token endpoint will with the access token.

```json
HTTP/1.1 200 OK

{
  "token_type": "Bearer",
  "access_token": "RsT5OjbzRn430zqMLgV3Ia",
  "expires_in": 3600,
  "refresh_token": "b7a3fac6b10e13bb3a276c2aab35e97298a060e0ede5b43ed1f720a8"
}
```

### 5. OIDC